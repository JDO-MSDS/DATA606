---
title: "DATA 606 Data Project Proposal"
author: "João De Oliveira"
output: pdf_document
params:
  local_csv_path: "full_data.csv"
---

## Research question

**Does greater ball possession significantly increase a team’s probability of winning (vs not winning = loss or draw) in professional soccer?**


## Data Preparation

```{r setup, include=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readr)

pick_first <- function(df, candidates, default = NA) {
  cols <- intersect(candidates, names(df))
  if (length(cols) == 0) return(rep(default, nrow(df)))
  out <- df[[cols[1]]]
  if (length(cols) > 1) {
    for (cn in cols[-1]) out <- dplyr::coalesce(out, df[[cn]])
  }
  out
}

# parse possession 
parse_poss <- function(x) {
  if (is.null(x)) return(NA_real_)
  x <- gsub("%", "", x)
  suppressWarnings(as.numeric(x))
}
```

```{r load_data, include=TRUE, echo=TRUE, message=TRUE, warning=FALSE}
# Read from your local Windows path because csv is too big
local_path <- params$local_csv_path
message("Attempting to read CSV from: ", local_path)

matches_raw <- read_csv(local_path, show_col_types = FALSE)

# Show available columns for mapping
names(matches_raw)
glimpse(matches_raw, width = 120)
```

```{r tidy_mapping, include=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
std <- matches_raw %>%
  mutate(
    # Teams
    home_team = pick_first(., c("Home","home_team","HomeTeam","home","HomeTeamName"), default = NA_character_),
    away_team = pick_first(., c("Away","away_team","AwayTeam","away","AwayTeamName"), default = NA_character_),
    # Goals (numeric)
    home_goals = suppressWarnings(as.numeric(pick_first(., c("H_Score","home_goals","FTHG","home_score","HomeGoals","home_team_goals"), default = NA_real_))),
    away_goals = suppressWarnings(as.numeric(pick_first(., c("A_Score","away_goals","FTAG","away_score","AwayGoals","away_team_goals"), default = NA_real_))),
    # Possession (parse % -> numeric)
    home_poss_chr = pick_first(., c("H_Ball_Possession","home_possession","HomePossession"), default = NA_character_),
    away_poss_chr = pick_first(., c("A_Ball_Possession","away_possession","AwayPossession"), default = NA_character_),
    home_poss = parse_poss(home_poss_chr),
    away_poss = parse_poss(away_poss_chr),
    # Outcome label if goals NA
    win_label = pick_first(., c("WIN","Result"), default = NA_character_)
  ) %>%
  mutate(
    # If only one side of possession exists, infer the other
    home_poss = ifelse(!is.na(home_poss), home_poss,
                       ifelse(!is.na(away_poss), 100 - away_poss, NA_real_)),
    away_poss = ifelse(!is.na(away_poss), away_poss,
                       ifelse(!is.na(home_poss), 100 - home_poss, NA_real_))
  )

# Build team-match rows
home_rows <- std %>%
  transmute(team = home_team, opponent = away_team,
            team_goals = home_goals, opp_goals = away_goals,
            team_poss = home_poss,  opp_poss = away_poss,
            win_label = win_label,
            is_home = 1L)

away_rows <- std %>%
  transmute(team = away_team, opponent = home_team,
            team_goals = away_goals, opp_goals = home_goals,
            team_poss = away_poss,  opp_poss = home_poss,
            win_label = win_label,
            is_home = 0L)

teams_df <- bind_rows(home_rows, away_rows) %>%
  mutate(
    # Primary outcome from goals when available
    team_win_bin_goals = dplyr::case_when(
      !is.na(team_goals) & !is.na(opp_goals) & team_goals > opp_goals ~ 1L,
      !is.na(team_goals) & !is.na(opp_goals) ~ 0L,
      TRUE ~ NA_integer_
    ),
    # Fallback from WIN col if goals missing
    team_win_bin_fallback = dplyr::case_when(
      is.na(team_win_bin_goals) & !is.na(win_label) & win_label == "Home" & is_home == 1L ~ 1L,
      is.na(team_win_bin_goals) & !is.na(win_label) & win_label == "Away" & is_home == 0L ~ 1L,
      is.na(team_win_bin_goals) & !is.na(win_label) & win_label %in% c("Home","Away","Draw") ~ 0L,
      TRUE ~ NA_integer_
    ),
    team_win_bin = dplyr::coalesce(team_win_bin_goals, team_win_bin_fallback),
    poss_diff = team_poss - opp_poss
  )

# show usable rows after mapping
diag_counts <- teams_df %>%
  summarize(
    n = n(),
    n_win_na = sum(is.na(team_win_bin)),
    n_poss_na = sum(is.na(team_poss)),
    complete_cases = sum(!is.na(team_win_bin) & !is.na(team_poss))
  )
diag_counts

glimpse(teams_df, width = 120)
```



### Cases 

**What are the cases, and how many are there?**
Each case represents a single soccer match. The dataset includes over 96,000 matches from 18 European soccer leagues (10 countries) from 2011 to 2021.

### Data Collection

**Describe the method of data collection**

Dataset was collected by Kaggle user Sebastian Gębala. The data were scrapped from a livescore stats web page provider. The data include match statistics such as goals, shots, attacks, possession, corners, etc.


### Type of study 

**What type of study is this (observational/experiment)?**
This is an observational study since no experimental manipulation has been conducted. 


### Data Source 

**If you collected the data, state self-collected. If not, provide a citation/link.**
Kaggle - Football DataSet +96k matches (18 leagues): https://www.kaggle.com/datasets/bastekforever/complete-football-data-89000-matches-18-leagues 


Data was directly downloaded from Kaggle.

Gębala, S. (2023). Football DataSet +96k matches (18 leagues). Kaggle. Retrieved from the dataset page.


### Response Variable
The response variable is team winning - binary where 1 represents winning a game and 0 represents not winning

### Explanatory
Team ball possession is a numeric variable that will be the key predictor. Other variables, such as shots, pass accuracy, home vs away, will be used as optional controls.


## Relevant summary statistics

```{r summaries, echo=TRUE, message=FALSE, warning=FALSE}
table(teams_df$team_win_bin, useNA = "ifany")
summary(teams_df$team_poss)

teams_df %>%
  filter(!is.na(team_poss), !is.na(team_win_bin)) %>%
  mutate(outcome = ifelse(team_win_bin == 1, "Win", "Not-Win")) %>%
  ggplot(aes(x = outcome, y = team_poss, fill = outcome)) +
  geom_boxplot(alpha = 0.7, outlier.alpha = 0.3) +
  labs(title = "Team Possession by Outcome",
       x = "Outcome", y = "Team Possession (%)") +
  theme_minimal()
```

```{r chi_square_stub, echo=TRUE, message=FALSE, warning=FALSE}
teams_binned <- teams_df %>%
  filter(!is.na(team_poss), !is.na(team_win_bin)) %>%
  mutate(poss_bin = cut(team_poss,
                        breaks = c(-Inf, 40, 50, 60, Inf),
                        labels = c("<40%", "40–50%", "50–60%", ">60%")),
         outcome = ifelse(team_win_bin==1,"Win","Not-Win"))

tab <- table(teams_binned$poss_bin, teams_binned$outcome, useNA = "ifany")
tab
```

```{r logit_stub_safe, echo=TRUE, message=FALSE, warning=FALSE}
complete_df <- teams_df %>%
  filter(!is.na(team_poss), !is.na(team_win_bin)) %>%
  mutate(team_win_bin = as.integer(team_win_bin))

n_obs <- nrow(complete_df)
n_classes <- length(unique(complete_df$team_win_bin))
sd_poss <- sd(complete_df$team_poss, na.rm = TRUE)

cat("Obs available for glm:", n_obs, "| Classes:", n_classes, "| sd(team_poss):", sd_poss, "\n")

if (n_obs >= 50 && n_classes > 1 && is.finite(sd_poss) && sd_poss > 0) {
  mdl <- glm(team_win_bin ~ scale(team_poss),
             data = complete_df,
             family = binomial())
  print(summary(mdl))
} else {
  cat("Skipping glm: not enough usable data yet (need >=50 rows, >1 class, and nonzero variance in possession).\n")
  cat("If many values are still NA, verify that the possession columns are populated in your CSV.\n")
}
```
